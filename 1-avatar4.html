<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Wobble Drag</title>

    <script src="../../assets/template.min.js"></script>
    <link rel="stylesheet" href="../../assets/template.css" type="text/css" />
</head>

<body class="template">

<canvas id="canvas" width="800" height="600" style="background-color: #222"></canvas>

<script src="http://code.createjs.com/createjs-2015.05.21.min.js"></script>
<script src="webgl-0.8.1.min.js"></script>

<script>
    var stage = new createjs.Stage("canvas");
    //stage.enableMouseOver();
    createjs.Touch.enable(stage);
    LabTemplate.setupStageResize(stage);

    var m = new createjs.Point(),
            dragging = false,
            currentAvatar,
            yPos = 0.6,
            container,
            finishDrags=[],
            pacman,
            pieces = [];

    var avatarImages = ["Grant","Bobi","Lanny","Wes","Sebastian","Graves","Eddie","Shawn","Trevor","David","Chris","Alex","Mike","Blair","Manny","Jared","Patrick"];
    var queue = new createjs.LoadQueue(false);
    var manifest = [];
    for (var i= 0, l=avatarImages.length; i<l; i++) {
        var item = "ghost";//avatarImages[i];
        manifest.push({src:"Avatars/" + item + ".png", id:item});
    }
    manifest.push({src:"Avatars/pacman.png", id:"pacman"});

    queue.on("fileload", handleImageLoad);
    queue.on("complete", handleLoad);
    queue.loadManifest(manifest);

    function handleImageLoad(event) {
        var image = event.result;
        var ss2 = new createjs.SpriteSheet({
            images:[image],
            frames: {width:image.width,height:1,count:image.height}
        });

        container = new createjs.Container(ss2);
        container.vx = container.vy = 0;
        container.mouseChildren = false;
        container.cursor = "pointer";

        var sprites = container.sprites = [],
            pos = new createjs.Point(Math.random() * (stage.canvas.width-100)+50|0, Math.random()*(stage.canvas.height-200)+100|0);

        var matrix = new createjs.ColorMatrix().adjustHue(Math.random()*360-180);

        for (var i= 0, l=image.height; i<l; i++) {

            var sprite = new createjs.Sprite(ss2);
            sprite.gotoAndStop(i);
            sprite.x = pos.x;
            sprite.y = pos.y+i;
            sprite.regX = image.width/2;

            if (event.item.id != "pacman") {
                sprite.filters = [
                    new createjs.ColorMatrixFilter(matrix)
                ];
                sprite.cache(0, 0, image.width, 1);
            } else if (i==0) {
                pacman = sprite;
                container.pacman = true;
            }

            container.addChild(sprite);
            sprites.push(sprite);
            pieces.push(sprite);
        }
        stage.addChild(container);

        container.on("mousedown", startDrag);
        container.on("pressmove", handleDrag);
        container.on("pressup", handleRelease);
    }

    function handleLoad(event) {
        stage.update();
        LabTemplate.loadComplete();
        createjs.Ticker.on("tick", update);
    };

    function startDrag(event) {
        currentAvatar = event.currentTarget;
        finishDrags.splice(finishDrags.indexOf(currentAvatar));
        handleDrag(event);
        stage.addChild(currentAvatar);
        update();
    }
    function handleDrag(event) {
        m.setValues(event.stageX, event.stageY);

        // Look
        for (var i = 0, l=pieces.length; i < l; i++) {
            var obj = pieces[i];
            if (obj.parent.pacman) { continue; }
            obj.scaleX = (obj.x < pacman.x) ? 1 : -1;
        }

    }
    function handleRelease(event) {
        finishDrags.push(currentAvatar);
        currentAvatar.target = m.clone();
        currentAvatar = null;
    }

    // Update the current drag
    function update(event) {
        if (currentAvatar != null) {
            updateAvatar(currentAvatar, m);
        }
        for (var i = 0, l=finishDrags.length; i<l; i++) {
            updateAvatar(finishDrags[i]);
        }

        if (currentAvatar != null || finishDrags.length > 0) {
            stage.update(event);
        }
    }

    function updateAvatar(container, target) {

        if (container == null) { return; }

        var sprites = container.sprites,
            leftOver = 0;

        for (var i=0, l=sprites.length; i<l; i++) {

            var sprite = sprites[i];

            if (target == null) {
                target = container.target;
            }

            if (i == 0) {
                container.vx += (target.x - sprite.x) * 0.8;
                container.vy += (target.y + i - sprite.y) * 0.5;
                container.vx *= 0.5;
                container.vy *= 0.5;

                sprite.x += container.vx;
                sprite.y += container.vy;

                sprite.x = sprite.x + 0.5 | 0;
                sprite.y = sprite.y + 0.5 | 0;
            } else {
                sprite.x += (target.x - sprite.x) * 0.95;
                sprite.y += (target.y+1 - sprite.y) * 0.95;

                leftOver += Math.abs(target.y+1 - sprite.y) + Math.abs(target.x - sprite.x);
            }

            target = sprite;
        }

        // Stretch to fill
        for (var i=0, l=sprites.length-1; i<l; i++) {
            sprite = sprites[i];
            var nextKid = sprites[i+1];
            sprite.scaleY = (nextKid.y - sprite.y);
        }

        // Remove from list!
        if (container != currentAvatar && leftOver < 1) {
            var index = finishDrags.indexOf(container);
            finishDrags.splice(index, 1);
        }
    }

</script>
</body>
</html>